<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GigaVector Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f5f0;
  --bg-card: #ffffff;
  --bg-sidebar: #ffffff;
  --bg-input: #f0f0eb;
  --border: #e0dfd8;
  --border-light: #eae9e3;
  --text: #1a1a1a;
  --text-secondary: #5c5c5c;
  --text-muted: #999990;
  --accent: #e11d48;
  --accent-light: #fff1f2;
  --accent-text: #be123c;
  --green: #16a34a;
  --green-bg: #f0fdf4;
  --red: #dc2626;
  --red-bg: #fef2f2;
  --font: 'Source Sans 3', sans-serif;
  --mono: 'IBM Plex Mono', monospace;
  --sidebar-w: 220px;
  --radius: 8px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#d4d4d8;border-radius:3px}
body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:15px;line-height:1.55;-webkit-font-smoothing:antialiased}

/* ── Sidebar ── */
.sidebar{
  width:var(--sidebar-w);background:var(--bg-sidebar);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:10;
}
.sidebar-brand{
  height:56px;padding:0 20px;display:flex;align-items:center;gap:12px;
  border-bottom:1px solid var(--border);box-sizing:border-box;
}
.brand-mark{
  width:32px;height:32px;border-radius:8px;overflow:hidden;flex-shrink:0;
}
.brand-mark img{width:100%;height:100%;object-fit:cover;display:block}
.brand-name{font-size:15px;font-weight:700;color:var(--text);letter-spacing:-0.3px}
.sidebar-nav{flex:1;padding:12px 8px}
.sidebar-nav a{
  display:flex;align-items:center;gap:10px;padding:9px 12px;
  border-radius:6px;color:var(--text-muted);text-decoration:none;
  font-size:14px;font-weight:500;transition:all 0.12s;margin-bottom:2px;
}
.sidebar-nav a:hover{color:var(--text-secondary);background:var(--bg-input)}
.sidebar-nav a.active{color:var(--text);background:var(--bg-input);font-weight:600}
.sidebar-nav a svg{width:16px;height:16px;opacity:0.4;flex-shrink:0}
.sidebar-nav a:hover svg{opacity:0.6}
.sidebar-nav a.active svg{opacity:0.8}
.sidebar-footer{
  padding:14px 20px;border-top:1px solid var(--border);
  font-family:var(--mono);font-size:11px;color:var(--text-muted);line-height:1.6;
}
.sidebar-footer span{color:var(--text-secondary)}

/* ── Main ── */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh}
.header{
  height:56px;background:var(--bg-sidebar);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 28px;flex-shrink:0;
}
.header-title{font-size:15px;font-weight:700;color:var(--text);letter-spacing:-0.2px}
.header-right{display:flex;align-items:center;gap:14px}
.status-badge{
  display:flex;align-items:center;gap:6px;font-family:var(--mono);font-size:12px;color:var(--text-secondary);
}
.status-dot{width:8px;height:8px;border-radius:50%}
.status-dot.healthy{background:var(--green)}
.status-dot.degraded{background:#eab308}
.status-dot.unhealthy{background:var(--red)}
.uptime-badge{font-family:var(--mono);font-size:11px;color:var(--text-muted)}
.content{padding:28px;flex:1;overflow-y:auto}

/* ── Cards ── */
.cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px;margin-bottom:24px}
.card{
  background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);
  padding:20px;display:flex;flex-direction:column;gap:4px;
}
.card-label{font-family:var(--mono);font-size:11px;font-weight:500;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.card-value{font-family:var(--mono);font-size:28px;font-weight:600;font-variant-numeric:tabular-nums;color:var(--text);line-height:1.2}
.card-value.accent{color:var(--accent)}
.card-sub{font-family:var(--mono);font-size:11px;color:var(--text-muted)}

/* ── Forms ── */
input,textarea,select{
  background:var(--bg-input);border:1px solid var(--border);color:var(--text);
  border-radius:6px;padding:9px 12px;font-size:14px;font-family:var(--font);outline:none;transition:border-color 0.15s;
}
input:focus,textarea:focus,select:focus{border-color:var(--text-muted)}
textarea{font-family:var(--mono);font-size:12px;resize:vertical}
.btn{
  background:var(--text);color:#fff;border:none;border-radius:6px;
  padding:9px 18px;font-size:14px;font-weight:600;font-family:var(--font);
  cursor:pointer;transition:opacity 0.15s;
}
.btn:hover{opacity:0.85}
.btn:disabled{opacity:0.4;cursor:not-allowed}
.btn-outline{background:var(--bg-card);border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{background:var(--bg-input);opacity:1}
.btn-danger{background:var(--red);color:#fff}
.btn-sm{padding:6px 12px;font-size:12px}
.form-group{margin-bottom:14px}
.form-group label{display:block;margin-bottom:5px;font-size:13px;font-weight:600;color:var(--text-secondary)}
.form-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}

/* ── Table ── */
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:8px 12px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--border)}
td{padding:9px 12px;border-bottom:1px solid var(--border-light);color:var(--text-secondary);font-size:14px}
tr:hover td{background:var(--bg-input)}
td.mono{font-family:var(--mono);font-size:12px}

/* ── JSON viewer ── */
.json-view{
  background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius);
  padding:16px;font-family:var(--mono);font-size:13px;white-space:pre-wrap;word-break:break-all;
  max-height:400px;overflow-y:auto;color:var(--text-secondary);line-height:1.65;
}
.json-key{color:#0369a1}.json-str{color:var(--green)}.json-num{color:var(--accent-text)}.json-bool{color:#7c3aed}.json-null{color:var(--text-muted)}

/* ── Views / Sections ── */
.view{display:none}.view.active{display:block}
.section{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px}
.section-title{font-size:15px;font-weight:700;margin-bottom:14px;color:var(--text)}
.section-desc{font-size:14px;color:var(--text-muted);margin-bottom:14px}

/* ── Tabs ── */
.tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:1px solid var(--border)}
.tab{
  padding:10px 18px;font-size:14px;font-weight:600;color:var(--text-muted);cursor:pointer;
  border-bottom:2px solid transparent;transition:all 0.12s;background:none;
  border-top:none;border-left:none;border-right:none;
}
.tab:hover{color:var(--text-secondary)}
.tab.active{color:var(--text);border-bottom-color:var(--text)}

/* ── Console ── */
.console-bar{display:flex;gap:8px;margin-bottom:14px}
.console-bar select{width:100px;font-family:var(--mono);font-size:12px;font-weight:500}
.console-bar input{flex:1;font-family:var(--mono);font-size:13px}
.console-response{margin-top:14px}
.console-meta{font-family:var(--mono);font-size:12px;color:var(--text-muted);margin-bottom:6px;display:flex;gap:14px}
.console-meta .status-ok{color:var(--green);font-weight:600}
.console-meta .status-err{color:var(--red);font-weight:600}

/* ── Toast ── */
.toast{
  position:fixed;bottom:24px;right:24px;background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px 20px;font-size:13px;color:var(--text);
  box-shadow:0 4px 16px rgba(0,0,0,0.08);z-index:100;opacity:0;transform:translateY(8px);
  transition:opacity 0.2s,transform 0.2s;
}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{border-left:3px solid var(--green)}
.toast.error{border-left:3px solid var(--red)}

/* ── Viz ── */
.viz-container{border:1px solid var(--border);border-radius:var(--radius);background:var(--bg-card);overflow:hidden;margin-bottom:16px}
.viz-canvas{display:block;width:100%;cursor:crosshair}
.viz-toolbar{display:flex;gap:8px;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);font-size:12px;color:var(--text-secondary);flex-wrap:wrap}
.viz-toolbar select,.viz-toolbar input[type=number]{font-size:12px;padding:5px 8px}
.viz-toolbar .btn{font-size:12px;padding:5px 14px}
.viz-info{padding:10px 16px;border-top:1px solid var(--border);font-family:var(--mono);font-size:11px;color:var(--text-muted);min-height:30px}
.viz-info b{color:var(--text);font-weight:600}
.viz-split{display:flex;gap:0;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;min-height:520px}
.viz-split .viz-main{flex:1;display:flex;flex-direction:column;min-width:0}
.viz-split .viz-detail{flex:0 0 280px;border-left:1px solid var(--border);overflow-y:auto;background:var(--bg-card)}
.viz-detail-header{padding:10px 16px;font-size:12px;font-weight:700;color:var(--text-secondary);border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:2}
.viz-detail-body{padding:16px}
.viz-detail-body .detail-label{font-family:var(--mono);font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.viz-detail-body .detail-value{font-family:var(--mono);font-size:13px;color:var(--text);margin-bottom:14px;word-break:break-all;line-height:1.5}
.viz-detail-body .detail-value.dim{color:var(--text-secondary)}
.viz-tooltip{
  position:fixed;pointer-events:none;z-index:50;
  background:var(--bg-card);border:1px solid var(--border);border-radius:6px;
  padding:10px 14px;box-shadow:0 4px 12px rgba(0,0,0,0.08);
  font-family:var(--mono);font-size:11px;color:var(--text);max-width:320px;
  opacity:0;transition:opacity 0.1s;
}
.viz-tooltip.visible{opacity:1}
.viz-tooltip .tt-id{font-weight:600;color:var(--accent);margin-bottom:3px}
.viz-tooltip .tt-dim{color:var(--text-muted);font-size:10px}
.viz-tooltip .tt-data{color:var(--text-secondary);margin-top:4px;font-size:10px;line-height:1.4;word-break:break-all}

/* ── Split layout ── */
.split-h{display:flex;gap:0;min-height:480px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.split-panel{flex:1;overflow:auto;background:var(--bg-card)}
.split-panel-sm{flex:0 0 300px;overflow:auto;background:var(--bg-card);border-left:1px solid var(--border)}
.split-panel-header{
  padding:12px 16px;font-size:12px;font-weight:700;color:var(--text-secondary);
  border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:2;
  display:flex;align-items:center;justify-content:space-between;
}
.points-list{overflow-y:auto;max-height:calc(480px - 82px)}
.point-item{
  display:flex;align-items:flex-start;gap:12px;padding:10px 16px;
  border-bottom:1px solid var(--border-light);cursor:pointer;transition:background 0.1s;
}
.point-item:hover{background:var(--bg-input)}
.point-item.selected{background:var(--accent-light);border-left:2px solid var(--accent)}
.point-idx{font-family:var(--mono);font-size:12px;color:var(--text-muted);min-width:36px;padding-top:1px}
.point-data{font-family:var(--mono);font-size:11px;color:var(--text-secondary);line-height:1.5;word-break:break-all;flex:1}
.point-badge{font-family:var(--mono);font-size:10px;color:var(--text-muted);background:var(--bg-input);padding:2px 6px;border-radius:4px}

/* ── Responsive ── */
@media(max-width:768px){
  .sidebar{width:56px}
  .brand-name,.sidebar-nav a span,.sidebar-footer{display:none}
  .sidebar-brand{padding:14px;justify-content:center}
  .sidebar-nav a{justify-content:center;padding:10px}
  .main{margin-left:56px}
  .cards{grid-template-columns:repeat(auto-fill,minmax(150px,1fr))}
  .content{padding:16px}
  .split-h{flex-direction:column}
  .split-panel-sm{flex:0 0 auto;border-left:none;border-top:1px solid var(--border)}
}
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-brand">
    <div class="brand-mark"><img src="/dashboard/logo.png" alt="GigaVector"></div>
    <div class="brand-name">GigaVector</div>
  </div>
  <nav class="sidebar-nav">
    <a href="#overview" class="active" data-view="overview">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
      <span>Overview</span>
    </a>
    <a href="#vectors" data-view="vectors">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
      <span>Vectors</span>
    </a>
    <a href="#visualize" data-view="visualize">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7.5" cy="7.5" r="2"/><circle cx="16.5" cy="16.5" r="2"/><circle cx="16.5" cy="7.5" r="2"/><circle cx="7.5" cy="16.5" r="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="8" x2="9" y2="15"/></svg>
      <span>Visualize</span>
    </a>
    <a href="#search" data-view="search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span>Search</span>
    </a>
    <a href="#console" data-view="console">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
      <span>Console</span>
    </a>
  </nav>
  <div class="sidebar-footer">
    <span id="footer-version">GigaVector</span><br>
    <span id="footer-index"></span>
  </div>
</div>

<div class="main">
  <div class="header">
    <div class="header-title" id="viewTitle">Overview</div>
    <div class="header-right">
      <div class="uptime-badge" id="uptimeBadge"></div>
      <div class="status-badge"><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting...</span></div>
    </div>
  </div>
  <div class="content">

    <!-- OVERVIEW -->
    <div class="view active" id="view-overview">
      <div class="cards">
        <div class="card"><div class="card-label">Vectors</div><div class="card-value accent" id="ov-count">&mdash;</div></div>
        <div class="card"><div class="card-label">Dimension</div><div class="card-value" id="ov-dim">&mdash;</div></div>
        <div class="card"><div class="card-label">Index Type</div><div class="card-value" id="ov-index">&mdash;</div></div>
        <div class="card"><div class="card-label">Version</div><div class="card-value" id="ov-version">&mdash;</div></div>
      </div>
      <div class="cards">
        <div class="card"><div class="card-label">Total Requests</div><div class="card-value" id="ov-reqs">&mdash;</div></div>
        <div class="card"><div class="card-label">Queries/sec</div><div class="card-value" id="ov-qps">&mdash;</div></div>
        <div class="card"><div class="card-label">Errors</div><div class="card-value" id="ov-errors">&mdash;</div></div>
        <div class="card"><div class="card-label">Data Sent</div><div class="card-value" id="ov-sent">&mdash;</div><div class="card-sub" id="ov-recv"></div></div>
      </div>
      <div class="section">
        <div class="section-title">Health</div>
        <div class="json-view" id="ov-health-json" style="min-height:60px">&mdash;</div>
      </div>
    </div>

    <!-- VECTORS -->
    <div class="view" id="view-vectors">
      <div class="tabs">
        <button class="tab active" data-tab="vec-browse">Browse</button>
        <button class="tab" data-tab="vec-add">Add</button>
      </div>
      <div id="vec-browse" class="tab-content">
        <div class="split-h">
          <div class="split-panel">
            <div class="split-panel-header">
              Points
              <span id="points-count" style="font-family:var(--mono);font-weight:400;color:var(--text-muted)"></span>
            </div>
            <div style="padding:8px 12px;border-bottom:1px solid var(--border);display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <label style="font-size:11px;color:var(--text-muted);font-weight:600">Offset</label>
              <input type="number" id="points-offset" value="0" min="0" style="width:70px;font-size:12px;padding:5px 8px">
              <label style="font-size:11px;color:var(--text-muted);font-weight:600">Limit</label>
              <input type="number" id="points-limit" value="50" min="1" max="200" style="width:60px;font-size:12px;padding:5px 8px">
              <button class="btn btn-sm" onclick="loadPoints()">Load</button>
              <button class="btn btn-sm btn-outline" onclick="pointsPrev()">&larr;</button>
              <button class="btn btn-sm btn-outline" onclick="pointsNext()">&rarr;</button>
            </div>
            <div class="points-list" id="points-list"></div>
          </div>
          <div class="split-panel-sm">
            <div class="split-panel-header">Detail</div>
            <div id="point-detail" style="padding:16px">
              <div style="font-size:12px;color:var(--text-muted)">Select a point from the list.</div>
            </div>
          </div>
        </div>
      </div>
      <div id="vec-add" class="tab-content" style="display:none">
        <div class="section">
          <div class="section-title">Add Vector</div>
          <div class="section-desc">Provide vector components as a JSON array. Dimension must match the database.</div>
          <div class="form-group"><label>Vector Data (JSON array)</label><textarea id="vec-add-data" rows="3" style="width:100%" placeholder="[0.1, 0.2, 0.3, 0.4]"></textarea></div>
          <div class="form-group"><label>Metadata (optional JSON)</label><textarea id="vec-add-meta" rows="2" style="width:100%" placeholder='{"label": "example"}'></textarea></div>
          <button class="btn" onclick="addVector()">Add Vector</button>
        </div>
      </div>
    </div>

    <!-- VISUALIZE -->
    <div class="view" id="view-visualize">
      <div class="tabs">
        <button class="tab active" data-tab="viz-scatter">Scatter Plot</button>
        <button class="tab" data-tab="viz-graph">Similarity Graph</button>
      </div>
      <div id="viz-scatter" class="tab-content">
        <div class="viz-split">
          <div class="viz-main">
            <div class="viz-toolbar">
              <label style="font-weight:600">Algorithm</label>
              <select id="viz-algo"><option value="pca">PCA</option><option value="random">Random Projection</option></select>
              <label style="font-weight:600">Limit</label>
              <input type="number" id="viz-limit" value="200" min="10" max="500" style="width:70px">
              <button class="btn btn-sm" onclick="runVisualization()">Run</button>
              <span id="viz-status" style="margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--text-muted)"></span>
            </div>
            <canvas class="viz-canvas" id="scatter-canvas" width="900" height="460"></canvas>
            <div class="viz-info" id="scatter-info">Click <b>Run</b> to project vectors into 2D space. Hover to preview, click to inspect.</div>
          </div>
          <div class="viz-detail" id="scatter-detail">
            <div class="viz-detail-header">Point Detail</div>
            <div class="viz-detail-body" id="scatter-detail-body">
              <div style="color:var(--text-muted);font-size:13px">Click a point on the scatter plot to inspect it here.</div>
            </div>
          </div>
        </div>
      </div>
      <div id="viz-graph" class="tab-content" style="display:none">
        <div class="viz-split">
          <div class="viz-main">
            <div class="viz-toolbar">
              <label style="font-weight:600">Seed</label>
              <input type="number" id="graph-seed" value="0" min="0" style="width:70px">
              <label style="font-weight:600">k</label>
              <input type="number" id="graph-k" value="5" min="1" max="20" style="width:50px">
              <label style="font-weight:600">Depth</label>
              <input type="number" id="graph-depth" value="2" min="1" max="4" style="width:50px">
              <button class="btn btn-sm" onclick="runGraph()">Build</button>
              <span id="graph-status" style="margin-left:auto;font-family:var(--mono);font-size:11px;color:var(--text-muted)"></span>
            </div>
            <canvas class="viz-canvas" id="graph-canvas" width="900" height="460"></canvas>
            <div class="viz-info" id="graph-info">Build a similarity graph from a seed point. Hover nodes to preview, click to inspect.</div>
          </div>
          <div class="viz-detail" id="graph-detail">
            <div class="viz-detail-header">Node Detail</div>
            <div class="viz-detail-body" id="graph-detail-body">
              <div style="color:var(--text-muted);font-size:13px">Click a node on the graph to inspect it here.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SEARCH -->
    <div class="view" id="view-search">
      <div class="tabs">
        <button class="tab active" data-tab="search-knn">k-NN Search</button>
        <button class="tab" data-tab="search-range">Range Search</button>
      </div>
      <div id="search-knn" class="tab-content">
        <div class="section">
          <div class="section-title">k-NN Search</div>
          <div class="form-group"><label>Query Vector (JSON array)</label><textarea id="search-query" rows="2" style="width:100%" placeholder="[0.1, 0.2, 0.3, 0.4]"></textarea></div>
          <div class="form-row" style="margin-bottom:14px">
            <div class="form-group" style="margin-bottom:0"><label>k</label><input type="number" id="search-k" value="5" min="1" style="width:70px"></div>
            <div class="form-group" style="margin-bottom:0"><label>Distance</label><select id="search-dist"><option value="euclidean">Euclidean</option><option value="cosine">Cosine</option><option value="dot_product">Dot Product</option><option value="manhattan">Manhattan</option></select></div>
            <button class="btn" onclick="doSearch()">Search</button>
          </div>
          <div id="search-meta" style="font-family:var(--mono);font-size:11px;color:var(--text-muted);margin-bottom:8px"></div>
          <table id="search-results" style="display:none"><thead><tr><th>#</th><th>Index</th><th>Distance</th><th>Data</th></tr></thead><tbody id="search-tbody"></tbody></table>
          <div id="search-empty" style="color:var(--text-muted);font-size:13px">Enter a query vector and click Search.</div>
        </div>
      </div>
      <div id="search-range" class="tab-content" style="display:none">
        <div class="section">
          <div class="section-title">Range Search</div>
          <div class="form-group"><label>Query Vector (JSON array)</label><textarea id="range-query" rows="2" style="width:100%" placeholder="[0.1, 0.2, 0.3, 0.4]"></textarea></div>
          <div class="form-row" style="margin-bottom:14px">
            <div class="form-group" style="margin-bottom:0"><label>Radius</label><input type="number" id="range-radius" value="1.0" step="0.1" min="0" style="width:90px"></div>
            <div class="form-group" style="margin-bottom:0"><label>Max Results</label><input type="number" id="range-max" value="100" min="1" style="width:90px"></div>
            <div class="form-group" style="margin-bottom:0"><label>Distance</label><select id="range-dist"><option value="euclidean">Euclidean</option><option value="cosine">Cosine</option><option value="dot_product">Dot Product</option><option value="manhattan">Manhattan</option></select></div>
            <button class="btn" onclick="doRangeSearch()">Search</button>
          </div>
          <div id="range-meta" style="font-family:var(--mono);font-size:11px;color:var(--text-muted);margin-bottom:8px"></div>
          <table id="range-results" style="display:none"><thead><tr><th>#</th><th>Index</th><th>Distance</th><th>Data</th></tr></thead><tbody id="range-tbody"></tbody></table>
          <div id="range-empty" style="color:var(--text-muted);font-size:13px">Enter a query vector and radius, then click Search.</div>
        </div>
      </div>
    </div>

    <!-- CONSOLE -->
    <div class="view" id="view-console">
      <div class="section">
        <div class="section-title">API Console</div>
        <div class="section-desc">Send HTTP requests to the GigaVector server.</div>
        <div class="console-bar">
          <select id="con-method"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
          <input type="text" id="con-url" value="/health" placeholder="/endpoint">
          <button class="btn" onclick="consoleSend()">Send</button>
        </div>
        <div class="form-group"><label>Request Body (JSON)</label><textarea id="con-body" rows="4" style="width:100%" placeholder="{}"></textarea></div>
        <div class="console-response">
          <div class="console-meta" id="con-meta"></div>
          <div class="json-view" id="con-result" style="min-height:100px"></div>
        </div>
      </div>
      <div class="section">
        <div class="section-title">Quick Actions</div>
        <div class="form-row">
          <button class="btn btn-sm btn-outline" onclick="quickReq('GET','/health')">Health</button>
          <button class="btn btn-sm btn-outline" onclick="quickReq('GET','/stats')">Stats</button>
          <button class="btn btn-sm btn-outline" onclick="quickReq('GET','/api/dashboard/info')">Info</button>
          <button class="btn btn-sm btn-outline" onclick="quickReq('POST','/compact')">Compact</button>
          <button class="btn btn-sm btn-outline" onclick="quickReq('POST','/save')">Save</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>
<div class="viz-tooltip" id="viz-tooltip"></div>

<script>
const API = window.location.origin;

function jsonHighlight(obj) {
  if (obj == null) return '<span class="json-null">null</span>';
  const s = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
  return s.replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g, m => {
    let cls = 'json-num';
    if (/^"/.test(m)) cls = /:$/.test(m) ? 'json-key' : 'json-str';
    else if (/true|false/.test(m)) cls = 'json-bool';
    else if (/null/.test(m)) cls = 'json-null';
    return '<span class="' + cls + '">' + m + '</span>';
  });
}

async function apiCall(path, opts) {
  try {
    const r = await fetch(API + path, opts);
    const text = await r.text();
    let data; try { data = JSON.parse(text); } catch { data = text; }
    return { status: r.status, data, ok: r.ok };
  } catch (e) { return { status: 0, data: { error: e.message }, ok: false }; }
}

function formatBytes(b) {
  if (b == null) return '—';
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  if (b < 1073741824) return (b/1048576).toFixed(1) + ' MB';
  return (b/1073741824).toFixed(2) + ' GB';
}
function formatUptime(s) {
  if (s == null || s < 0) return '';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s/60) + 'm ' + (s%60) + 's';
  return Math.floor(s/3600) + 'h ' + Math.floor((s%3600)/60) + 'm';
}
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + (type || '');
  clearTimeout(t._timer); t._timer = setTimeout(() => t.className = 'toast', 3000);
}

/* Tabs */
document.querySelectorAll('.tabs').forEach(tabs => {
  tabs.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.dataset.tab;
      tabs.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      tabs.parentElement.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      document.getElementById(target).style.display = 'block';
    });
  });
});

/* Nav */
document.querySelectorAll('.sidebar-nav a').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    const view = a.dataset.view;
    document.querySelectorAll('.sidebar-nav a').forEach(x => x.classList.remove('active'));
    a.classList.add('active');
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('view-' + view).classList.add('active');
    document.getElementById('viewTitle').textContent = a.querySelector('span').textContent;
    if (view === 'vectors') loadPoints();
  });
});

/* Overview */
let refreshTimer = null;
async function refreshOverview() {
  const [info, stats, health] = await Promise.all([apiCall('/api/dashboard/info'), apiCall('/stats'), apiCall('/health')]);
  const dot = document.getElementById('statusDot'), txt = document.getElementById('statusText');
  if (health.ok && health.data) {
    const s = health.data.status || 'unknown';
    dot.className = 'status-dot ' + s;
    txt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
    document.getElementById('ov-health-json').innerHTML = jsonHighlight(health.data);
    const up = health.data.uptime_seconds;
    document.getElementById('uptimeBadge').textContent = up != null ? 'Up ' + formatUptime(up) : '';
  } else {
    dot.className = 'status-dot unhealthy'; txt.textContent = 'Unreachable';
    document.getElementById('ov-health-json').innerHTML = '<span class="json-null">Server unreachable</span>';
    document.getElementById('uptimeBadge').textContent = '';
  }
  if (info.ok && info.data) {
    document.getElementById('ov-count').textContent = (info.data.vector_count ?? 0).toLocaleString();
    document.getElementById('ov-dim').textContent = info.data.dimension ?? '—';
    document.getElementById('ov-index').textContent = info.data.index_type ?? '—';
    document.getElementById('ov-version').textContent = info.data.version ?? '—';
    document.getElementById('footer-version').textContent = 'GigaVector v' + (info.data.version || '?');
    document.getElementById('footer-index').textContent = (info.data.index_type || '') + ' · dim ' + (info.data.dimension || '?');
  }
  if (stats.ok && stats.data) {
    document.getElementById('ov-reqs').textContent = ((stats.data.total_inserts || 0) + (stats.data.total_queries || 0)).toLocaleString();
    document.getElementById('ov-qps').textContent = stats.data.queries_per_second ?? '—';
    document.getElementById('ov-errors').textContent = (stats.data.error_count ?? 0).toLocaleString();
    document.getElementById('ov-sent').textContent = formatBytes(stats.data.total_bytes_sent);
    document.getElementById('ov-recv').textContent = stats.data.total_bytes_received != null ? 'Recv: ' + formatBytes(stats.data.total_bytes_received) : '';
  }
}
function startRefresh() { refreshOverview(); refreshTimer = setInterval(refreshOverview, 2500); }
startRefresh();

/* Points browser */
let currentPoints = [], selectedPointIdx = -1;
async function loadPoints() {
  const offset = parseInt(document.getElementById('points-offset').value) || 0;
  const limit = parseInt(document.getElementById('points-limit').value) || 50;
  const r = await apiCall('/vectors/scroll?offset=' + offset + '&limit=' + limit);
  if (!r.ok) return;
  currentPoints = r.data.vectors || [];
  document.getElementById('points-count').textContent = r.data.total + ' total';
  selectedPointIdx = -1;
  renderPointsList();
}
function pointsPrev() {
  const el = document.getElementById('points-offset');
  const lim = parseInt(document.getElementById('points-limit').value) || 50;
  el.value = Math.max(0, parseInt(el.value) - lim); loadPoints();
}
function pointsNext() {
  const el = document.getElementById('points-offset');
  const lim = parseInt(document.getElementById('points-limit').value) || 50;
  el.value = parseInt(el.value) + lim; loadPoints();
}
function renderPointsList() {
  const list = document.getElementById('points-list');
  if (!currentPoints.length) { list.innerHTML = '<div style="padding:20px;font-size:12px;color:var(--text-muted)">No vectors found.</div>'; return; }
  list.innerHTML = currentPoints.map((p, i) => {
    const d = Array.isArray(p.data) ? '[' + p.data.slice(0, 5).map(v => typeof v === 'number' ? v.toFixed(4) : v).join(', ') + (p.data.length > 5 ? ', …' : '') + ']' : JSON.stringify(p.data).slice(0, 60);
    return '<div class="point-item' + (selectedPointIdx === i ? ' selected' : '') + '" onclick="selectPoint(' + i + ')">' +
      '<div class="point-idx">' + p.index + '</div><div class="point-data">' + d + '</div>' +
      '<div class="point-badge">' + (Array.isArray(p.data) ? p.data.length + 'd' : '') + '</div></div>';
  }).join('');
}
function selectPoint(i) {
  selectedPointIdx = i; renderPointsList();
  const p = currentPoints[i];
  document.getElementById('point-detail').innerHTML =
    '<div style="font-family:var(--mono);font-size:12px;font-weight:600;color:var(--accent);margin-bottom:12px">Point #' + p.index + '</div>' +
    '<div class="json-view" style="max-height:300px;margin-bottom:12px">' + jsonHighlight(p) + '</div>' +
    '<button class="btn btn-sm btn-danger" onclick="deletePointFromBrowser(' + p.index + ')">Delete</button>';
}
async function deletePointFromBrowser(id) {
  if (!confirm('Delete vector ' + id + '?')) return;
  const r = await apiCall('/vectors/' + id, { method: 'DELETE' });
  showToast(r.ok ? 'Deleted #' + id : 'Failed', r.ok ? 'success' : 'error');
  if (r.ok) { selectedPointIdx = -1; loadPoints(); }
}
async function addVector() {
  const dataStr = document.getElementById('vec-add-data').value.trim();
  const metaStr = document.getElementById('vec-add-meta').value.trim();
  try {
    const body = { data: JSON.parse(dataStr) };
    if (metaStr) body.metadata = JSON.parse(metaStr);
    const r = await apiCall('/vectors', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    showToast(r.ok ? 'Vector added' : 'Failed: ' + JSON.stringify(r.data), r.ok ? 'success' : 'error');
  } catch (e) { showToast('Invalid JSON: ' + e.message, 'error'); }
}

/* Scatter Plot */
let vizData = null;
async function runVisualization() {
  const limit = parseInt(document.getElementById('viz-limit').value) || 200;
  const algo = document.getElementById('viz-algo').value;
  const status = document.getElementById('viz-status');
  status.textContent = 'Loading…';
  const r = await apiCall('/vectors/scroll?offset=0&limit=' + limit);
  if (!r.ok || !r.data.vectors || !r.data.vectors.length) { status.textContent = 'No data'; return; }
  const vecs = r.data.vectors;
  const raw = vecs.map(v => Array.isArray(v.data) ? v.data : []);
  const indices = vecs.map(v => v.index);
  const dim = raw[0].length;
  const pts = algo === 'pca' ? pcaProject(raw) : randomProject(raw);
  vizData = { pts, indices, raw };
  status.textContent = vecs.length + ' pts · ' + algo.toUpperCase();
  document.getElementById('scatter-info').innerHTML = '<b>' + vecs.length + '</b> vectors projected from <b>' + dim + 'D</b> → 2D. Hover to inspect.';
  drawScatter();
}

function pcaProject(data) {
  const n = data.length, d = data[0].length;
  const mean = new Float64Array(d);
  for (let i = 0; i < n; i++) for (let j = 0; j < d; j++) mean[j] += data[i][j];
  for (let j = 0; j < d; j++) mean[j] /= n;
  const c = data.map(r => r.map((v, j) => v - mean[j]));
  function powerIter(mat) {
    let v = new Float64Array(d); for (let j = 0; j < d; j++) v[j] = Math.random() - 0.5;
    for (let it = 0; it < 80; it++) {
      const nv = new Float64Array(d);
      for (let i = 0; i < n; i++) { let dot = 0; for (let j = 0; j < d; j++) dot += mat[i][j] * v[j]; for (let j = 0; j < d; j++) nv[j] += dot * mat[i][j]; }
      let nm = 0; for (let j = 0; j < d; j++) nm += nv[j] * nv[j]; nm = Math.sqrt(nm) || 1;
      for (let j = 0; j < d; j++) v[j] = nv[j] / nm;
    }
    return v;
  }
  const pc1 = powerIter(c);
  const deflated = c.map(r => { let dot = 0; for (let j = 0; j < d; j++) dot += r[j] * pc1[j]; return r.map((v, j) => v - dot * pc1[j]); });
  const pc2 = powerIter(deflated);
  return data.map((_, i) => { let x = 0, y = 0; for (let j = 0; j < d; j++) { x += c[i][j] * pc1[j]; y += c[i][j] * pc2[j]; } return [x, y]; });
}

function randomProject(data) {
  const d = data[0].length;
  const r1 = [], r2 = [];
  for (let j = 0; j < d; j++) { r1.push(Math.random() - 0.5); r2.push(Math.random() - 0.5); }
  let n1 = 0, n2 = 0;
  for (let j = 0; j < d; j++) { n1 += r1[j]*r1[j]; n2 += r2[j]*r2[j]; }
  n1 = Math.sqrt(n1); n2 = Math.sqrt(n2);
  for (let j = 0; j < d; j++) { r1[j] /= n1; r2[j] /= n2; }
  return data.map(row => { let x = 0, y = 0; for (let j = 0; j < d; j++) { x += row[j]*r1[j]; y += row[j]*r2[j]; } return [x, y]; });
}

function drawScatter() {
  const canvas = document.getElementById('scatter-canvas');
  const w = canvas.parentElement.clientWidth, h = 460;
  const dpr = window.devicePixelRatio || 1;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);
  if (!vizData) return;
  const { pts, indices } = vizData;
  const pad = 44;
  let mnX = Infinity, mxX = -Infinity, mnY = Infinity, mxY = -Infinity;
  for (const [x, y] of pts) { if (x < mnX) mnX = x; if (x > mxX) mxX = x; if (y < mnY) mnY = y; if (y > mxY) mxY = y; }
  const rx = (mxX - mnX) || 1, ry = (mxY - mnY) || 1;
  const sx = (w - pad * 2) / rx, sy = (h - pad * 2) / ry;
  function toS(x, y) { return [(x - mnX) * sx + pad, h - ((y - mnY) * sy + pad)]; }

  // Background
  ctx.fillStyle = '#f5f5f0'; ctx.fillRect(0, 0, w, h);

  // Grid
  ctx.strokeStyle = '#e0dfd8'; ctx.lineWidth = 0.5;
  for (let g = 0; g <= 8; g++) {
    const gx = pad + (w - pad * 2) * g / 8;
    ctx.beginPath(); ctx.moveTo(gx, pad); ctx.lineTo(gx, h - pad); ctx.stroke();
    const gy = pad + (h - pad * 2) * g / 8;
    ctx.beginPath(); ctx.moveTo(pad, gy); ctx.lineTo(w - pad, gy); ctx.stroke();
  }

  // Axes
  ctx.strokeStyle = '#d5d4cc'; ctx.lineWidth = 1;
  ctx.strokeRect(pad, pad, w - pad * 2, h - pad * 2);
  ctx.fillStyle = '#999990'; ctx.font = '10px "IBM Plex Mono"'; ctx.textAlign = 'center';
  ctx.fillText('PC1', w / 2, h - 8);
  ctx.save(); ctx.translate(10, h / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('PC2', 0, 0); ctx.restore();

  // Points
  for (let i = 0; i < pts.length; i++) {
    const [px, py] = toS(pts[i][0], pts[i][1]);
    ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI * 2);
    ctx.fillStyle = '#e11d48'; ctx.fill();
    ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI * 2);
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 1.5; ctx.stroke();
  }

  canvas._vizMap = { pts, indices, toS, w, h };
}

let scatterHovered = -1, scatterSelected = -1;
const vizTooltip = document.getElementById('viz-tooltip');

function scatterFindNearest(mx, my) {
  if (!vizData || !vizData.pts) return -1;
  const { pts, toS } = document.getElementById('scatter-canvas')._vizMap || {};
  if (!toS) return -1;
  let closest = -1, cd = 14;
  for (let i = 0; i < pts.length; i++) {
    const [sx, sy] = toS(pts[i][0], pts[i][1]);
    const d = Math.hypot(mx - sx, my - sy);
    if (d < cd) { cd = d; closest = i; }
  }
  return closest;
}

function showVizTooltip(e, html) {
  vizTooltip.innerHTML = html;
  vizTooltip.classList.add('visible');
  const r = vizTooltip.getBoundingClientRect();
  let tx = e.clientX + 14, ty = e.clientY - 10;
  if (tx + r.width > window.innerWidth - 8) tx = e.clientX - r.width - 10;
  if (ty + r.height > window.innerHeight - 8) ty = e.clientY - r.height - 10;
  if (ty < 8) ty = 8;
  vizTooltip.style.left = tx + 'px';
  vizTooltip.style.top = ty + 'px';
}
function hideVizTooltip() { vizTooltip.classList.remove('visible'); }

function showScatterDetail(idx) {
  const body = document.getElementById('scatter-detail-body');
  if (idx < 0 || !vizData) {
    body.innerHTML = '<div style="color:var(--text-muted);font-size:13px">Click a point on the scatter plot to inspect it here.</div>';
    return;
  }
  const pt = vizData.raw[idx], id = vizData.indices[idx];
  const vecStr = '[' + pt.map(v => v.toFixed(6)).join(', ') + ']';
  body.innerHTML =
    '<div class="detail-label">Point ID</div><div class="detail-value" style="font-size:16px;font-weight:600;color:var(--accent)">#' + id + '</div>' +
    '<div class="detail-label">Dimension</div><div class="detail-value dim">' + pt.length + '</div>' +
    '<div class="detail-label">Projected (x, y)</div><div class="detail-value dim">' + vizData.pts[idx][0].toFixed(4) + ', ' + vizData.pts[idx][1].toFixed(4) + '</div>' +
    '<div class="detail-label">Vector Data</div><div class="detail-value" style="font-size:11px;line-height:1.6;max-height:220px;overflow-y:auto;background:var(--bg-input);padding:10px;border-radius:6px">' + vecStr + '</div>' +
    '<button class="btn btn-sm btn-outline" style="margin-top:4px" onclick="navigator.clipboard.writeText(\'' + vecStr.replace(/'/g,"\\'") + '\');showToast(\'Copied!\',\'success\')">Copy Vector</button>';
}

function drawScatterWithHighlights() {
  drawScatter();
  if (!vizData || !vizData.pts) return;
  const canvas = document.getElementById('scatter-canvas');
  const { pts, indices, toS } = canvas._vizMap || {};
  if (!toS) return;
  const dpr = window.devicePixelRatio || 1;
  const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);

  // Selected ring
  if (scatterSelected >= 0 && scatterSelected < pts.length) {
    const [sx, sy] = toS(pts[scatterSelected][0], pts[scatterSelected][1]);
    ctx.beginPath(); ctx.arc(sx, sy, 10, 0, Math.PI * 2);
    ctx.strokeStyle = '#e11d48'; ctx.lineWidth = 2.5; ctx.stroke();
    ctx.beginPath(); ctx.arc(sx, sy, 13, 0, Math.PI * 2);
    ctx.strokeStyle = 'rgba(225,29,72,0.2)'; ctx.lineWidth = 3; ctx.stroke();
  }
  // Hovered ring
  if (scatterHovered >= 0 && scatterHovered < pts.length && scatterHovered !== scatterSelected) {
    const [sx, sy] = toS(pts[scatterHovered][0], pts[scatterHovered][1]);
    ctx.beginPath(); ctx.arc(sx, sy, 8, 0, Math.PI * 2);
    ctx.strokeStyle = '#e11d48'; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = '#18181b'; ctx.font = '10px "IBM Plex Mono"'; ctx.textAlign = 'left';
    ctx.fillText('#' + indices[scatterHovered], sx + 12, sy + 4);
  }
  ctx.setTransform(1, 0, 0, 1, 0, 0);
}

document.getElementById('scatter-canvas').addEventListener('mousemove', function(e) {
  if (!this._vizMap || !vizData) return;
  const rect = this.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const prev = scatterHovered;
  scatterHovered = scatterFindNearest(mx, my);
  if (scatterHovered !== prev) drawScatterWithHighlights();
  if (scatterHovered >= 0) {
    const pt = vizData.raw[scatterHovered], id = vizData.indices[scatterHovered];
    const preview = '[' + pt.slice(0, 4).map(v => v.toFixed(3)).join(', ') + (pt.length > 4 ? ', \u2026' : '') + ']';
    showVizTooltip(e,
      '<div class="tt-id">Point #' + id + '</div>' +
      '<div class="tt-dim">' + pt.length + '-dimensional</div>' +
      '<div class="tt-data">' + preview + '</div>'
    );
    document.getElementById('scatter-info').innerHTML = 'Point <b>#' + id + '</b> \u2014 ' + pt.length + 'D \u2014 ' + preview;
  } else {
    hideVizTooltip();
  }
});
document.getElementById('scatter-canvas').addEventListener('mouseleave', function() {
  scatterHovered = -1; hideVizTooltip(); drawScatterWithHighlights();
});
document.getElementById('scatter-canvas').addEventListener('click', function(e) {
  if (!this._vizMap || !vizData) return;
  const rect = this.getBoundingClientRect();
  const mx = e.clientX - rect.left, my = e.clientY - rect.top;
  const idx = scatterFindNearest(mx, my);
  scatterSelected = (idx === scatterSelected) ? -1 : idx;
  drawScatterWithHighlights();
  showScatterDetail(scatterSelected);
});

/* Similarity graph */
let graphNodes = [], graphEdges = [], graphAnim = null;
async function runGraph() {
  const seed = parseInt(document.getElementById('graph-seed').value) || 0;
  const k = parseInt(document.getElementById('graph-k').value) || 5;
  const depth = parseInt(document.getElementById('graph-depth').value) || 2;
  const status = document.getElementById('graph-status');
  status.textContent = 'Building…';
  graphNodes = []; graphEdges = [];
  const visited = new Set();
  let frontier = [seed];
  for (let d = 0; d < depth && frontier.length; d++) {
    const next = [];
    for (const nid of frontier) {
      if (visited.has(nid)) continue; visited.add(nid);
      const vr = await apiCall('/vectors/' + nid);
      if (!vr.ok || !vr.data.data) continue;
      if (!graphNodes.find(n => n.id === nid))
        graphNodes.push({ id: nid, x: 450 + (Math.random()-0.5)*200, y: 230 + (Math.random()-0.5)*200, vx:0, vy:0, data: vr.data.data, depth: d });
      const sr = await apiCall('/search', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query:vr.data.data, k:k+1, distance:'euclidean'}) });
      if (sr.ok && sr.data.results) {
        let cnt = 0;
        for (const hit of sr.data.results) {
          if (cnt >= k || !hit.data) continue;
          let tid = -1;
          for (const ex of graphNodes) { if (JSON.stringify(ex.data) === JSON.stringify(hit.data)) { tid = ex.id; break; } }
          if (tid === -1) { tid = 2000 + graphNodes.length; graphNodes.push({ id: tid, x: 450+(Math.random()-0.5)*300, y:230+(Math.random()-0.5)*300, vx:0, vy:0, data:hit.data, depth:d+1 }); next.push(tid); }
          if (!graphEdges.find(e => (e.from===nid&&e.to===tid)||(e.from===tid&&e.to===nid)))
            graphEdges.push({ from:nid, to:tid, dist:hit.distance });
          cnt++;
        }
      }
    }
    frontier = next;
  }
  status.textContent = graphNodes.length + ' nodes · ' + graphEdges.length + ' edges';
  document.getElementById('graph-info').innerHTML = '<b>' + graphNodes.length + '</b> nodes, <b>' + graphEdges.length + '</b> edges from seed <b>#' + seed + '</b>';
  if (graphAnim) cancelAnimationFrame(graphAnim);
  simGraph();
}

let graphHovered = -1, graphSelected = -1;

function graphFindNearest(mx, my) {
  let closest = -1, cd = 16;
  for (let i = 0; i < graphNodes.length; i++) {
    const d = Math.hypot(mx - graphNodes[i].x, my - graphNodes[i].y);
    if (d < cd) { cd = d; closest = i; }
  }
  return closest;
}

function getNodeNeighbors(nodeIdx) {
  if (nodeIdx < 0) return [];
  const node = graphNodes[nodeIdx];
  const neighbors = [];
  for (const e of graphEdges) {
    if (e.from === node.id) {
      const nb = graphNodes.find(n => n.id === e.to);
      if (nb) neighbors.push({ id: nb.id, dist: e.dist });
    } else if (e.to === node.id) {
      const nb = graphNodes.find(n => n.id === e.from);
      if (nb) neighbors.push({ id: nb.id, dist: e.dist });
    }
  }
  return neighbors.sort((a, b) => (a.dist || 0) - (b.dist || 0));
}

function showGraphDetail(idx) {
  const body = document.getElementById('graph-detail-body');
  if (idx < 0) {
    body.innerHTML = '<div style="color:var(--text-muted);font-size:13px">Click a node on the graph to inspect it here.</div>';
    return;
  }
  const node = graphNodes[idx];
  const neighbors = getNodeNeighbors(idx);
  const vecStr = '[' + node.data.map(v => v.toFixed(6)).join(', ') + ']';
  let html =
    '<div class="detail-label">Node ID</div><div class="detail-value" style="font-size:16px;font-weight:600;color:var(--accent)">#' + node.id + '</div>' +
    '<div class="detail-label">Depth</div><div class="detail-value dim">' + node.depth + '</div>' +
    '<div class="detail-label">Dimension</div><div class="detail-value dim">' + node.data.length + '</div>' +
    '<div class="detail-label">Neighbors (' + neighbors.length + ')</div>';
  if (neighbors.length) {
    html += '<div style="margin-bottom:14px">';
    for (const nb of neighbors) {
      html += '<div style="display:flex;justify-content:space-between;padding:3px 0;font-family:var(--mono);font-size:11px;border-bottom:1px solid var(--border-light)">' +
        '<span style="color:var(--text)">#' + nb.id + '</span><span style="color:var(--text-muted)">' + (nb.dist != null ? nb.dist.toFixed(4) : '') + '</span></div>';
    }
    html += '</div>';
  }
  html += '<div class="detail-label">Vector Data</div>' +
    '<div class="detail-value" style="font-size:11px;line-height:1.6;max-height:180px;overflow-y:auto;background:var(--bg-input);padding:10px;border-radius:6px">' + vecStr + '</div>' +
    '<button class="btn btn-sm btn-outline" style="margin-top:4px" onclick="navigator.clipboard.writeText(\'' + vecStr.replace(/'/g,"\\'") + '\');showToast(\'Copied!\',\'success\')">Copy Vector</button>';
  body.innerHTML = html;
}

function simGraph() {
  const canvas = document.getElementById('graph-canvas');
  const w = canvas.parentElement.clientWidth, h = 460, dpr = window.devicePixelRatio || 1;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  let iter = 0;
  function drawGraphFrame() {
    const ctx = canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.fillStyle = '#fafafa'; ctx.fillRect(0,0,w,h);

    const hovNode = graphHovered >= 0 ? graphNodes[graphHovered] : null;
    const selNode = graphSelected >= 0 ? graphNodes[graphSelected] : null;
    const highlightIds = new Set();
    if (hovNode) { highlightIds.add(hovNode.id); for (const nb of getNodeNeighbors(graphHovered)) highlightIds.add(nb.id); }
    if (selNode) { highlightIds.add(selNode.id); for (const nb of getNodeNeighbors(graphSelected)) highlightIds.add(nb.id); }

    // Edges
    for (const e of graphEdges) {
      const a = graphNodes.find(n=>n.id===e.from), b = graphNodes.find(n=>n.id===e.to);
      if (!a||!b) continue;
      const isHL = (hovNode && (e.from===hovNode.id||e.to===hovNode.id)) || (selNode && (e.from===selNode.id||e.to===selNode.id));
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y);
      ctx.strokeStyle = isHL ? '#e11d48' : '#d5d4cc';
      ctx.lineWidth = isHL ? 2 : 1;
      ctx.globalAlpha = (hovNode || selNode) ? (isHL ? 1 : 0.25) : 1;
      ctx.stroke();
      if (e.dist != null) { ctx.fillStyle = isHL ? '#e11d48' : '#999990'; ctx.font='9px "IBM Plex Mono"'; ctx.textAlign='center'; ctx.fillText(e.dist.toFixed(2),(a.x+b.x)/2,(a.y+b.y)/2-5); }
    }
    ctx.globalAlpha = 1;

    // Nodes
    for (let i = 0; i < graphNodes.length; i++) {
      const n = graphNodes[i];
      const isHov = i === graphHovered, isSel = i === graphSelected;
      const inHL = highlightIds.has(n.id);
      ctx.globalAlpha = (hovNode || selNode) ? (inHL ? 1 : 0.2) : 1;
      const r = n.depth===0 ? 7 : 5;
      // Selected outer ring
      if (isSel) {
        ctx.beginPath(); ctx.arc(n.x,n.y,r+6,0,Math.PI*2);
        ctx.strokeStyle = 'rgba(225,29,72,0.2)'; ctx.lineWidth = 3; ctx.stroke();
        ctx.beginPath(); ctx.arc(n.x,n.y,r+3,0,Math.PI*2);
        ctx.strokeStyle = '#e11d48'; ctx.lineWidth = 2.5; ctx.stroke();
      }
      // Hover ring
      if (isHov && !isSel) {
        ctx.beginPath(); ctx.arc(n.x,n.y,r+4,0,Math.PI*2);
        ctx.strokeStyle = '#e11d48'; ctx.lineWidth = 2; ctx.stroke();
      }
      ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2);
      ctx.fillStyle = n.depth===0 ? '#e11d48' : (isSel ? '#e11d48' : '#18181b'); ctx.fill();
      ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
      ctx.fillStyle = '#5c5c5c'; ctx.font = '10px "IBM Plex Mono"'; ctx.textAlign='center';
      ctx.fillText('#'+n.id, n.x, n.y-12);
    }
    ctx.globalAlpha = 1;
    ctx.setTransform(1,0,0,1,0,0);
  }

  function tick() {
    const alpha = Math.max(0.001, 0.3 * Math.pow(0.99, iter));
    for (let i = 0; i < graphNodes.length; i++) for (let j = i+1; j < graphNodes.length; j++) {
      const dx = graphNodes[j].x-graphNodes[i].x, dy = graphNodes[j].y-graphNodes[i].y;
      const dist = Math.hypot(dx,dy)||1, f = 4000/(dist*dist)*alpha;
      graphNodes[i].vx -= dx/dist*f; graphNodes[i].vy -= dy/dist*f;
      graphNodes[j].vx += dx/dist*f; graphNodes[j].vy += dy/dist*f;
    }
    for (const e of graphEdges) {
      const a = graphNodes.find(n=>n.id===e.from), b = graphNodes.find(n=>n.id===e.to);
      if (!a||!b) continue;
      const dx=b.x-a.x, dy=b.y-a.y, dist=Math.hypot(dx,dy)||1, f=(dist-80)*0.04*alpha;
      a.vx+=dx/dist*f; a.vy+=dy/dist*f; b.vx-=dx/dist*f; b.vy-=dy/dist*f;
    }
    for (const n of graphNodes) {
      n.vx+=(w/2-n.x)*0.001*alpha; n.vy+=(h/2-n.y)*0.001*alpha;
      n.vx*=0.85; n.vy*=0.85; n.x+=n.vx; n.y+=n.vy;
      n.x=Math.max(24,Math.min(w-24,n.x)); n.y=Math.max(24,Math.min(h-24,n.y));
    }
    drawGraphFrame();
    iter++;
    if (iter < 250) graphAnim = requestAnimationFrame(tick);
  }
  tick();

  canvas.addEventListener('mousemove', function(e) {
    const rect = this.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const prev = graphHovered;
    graphHovered = graphFindNearest(mx, my);
    if (graphHovered !== prev) drawGraphFrame();
    if (graphHovered >= 0) {
      const node = graphNodes[graphHovered];
      const neighbors = getNodeNeighbors(graphHovered);
      showVizTooltip(e,
        '<div class="tt-id">Node #' + node.id + '</div>' +
        '<div class="tt-dim">' + node.data.length + 'D \u00b7 depth ' + node.depth + ' \u00b7 ' + neighbors.length + ' neighbors</div>' +
        '<div class="tt-data">[' + node.data.slice(0,3).map(v=>v.toFixed(3)).join(', ') + (node.data.length>3?', \u2026':'') + ']</div>'
      );
      document.getElementById('graph-info').innerHTML = 'Node <b>#' + node.id + '</b> \u2014 depth ' + node.depth + ' \u2014 ' + neighbors.length + ' neighbors';
    } else {
      hideVizTooltip();
    }
  });
  canvas.addEventListener('mouseleave', function() {
    graphHovered = -1; hideVizTooltip(); drawGraphFrame();
  });
  canvas.addEventListener('click', function(e) {
    const rect = this.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const idx = graphFindNearest(mx, my);
    graphSelected = (idx === graphSelected) ? -1 : idx;
    drawGraphFrame();
    showGraphDetail(graphSelected);
  });
}

/* Search */
function renderSearchResults(r, tbodyId, metaId, tableId, emptyId) {
  const tbody=document.getElementById(tbodyId), meta=document.getElementById(metaId);
  const tbl=document.getElementById(tableId), empty=document.getElementById(emptyId);
  if (r.ok && r.data && r.data.results) {
    meta.textContent = r.data.results.length + ' results' + (r.data.latency_ms ? ' in ' + r.data.latency_ms + 'ms' : '');
    tbody.innerHTML = '';
    r.data.results.forEach((h, i) => {
      const dp = h.data ? JSON.stringify(h.data).slice(0,50) + (JSON.stringify(h.data).length>50?'…':'') : '—';
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>'+(i+1)+'</td><td>'+(h.index??'—')+'</td><td class="mono">'+(h.distance!=null?h.distance.toFixed(6):'—')+'</td><td class="mono">'+dp+'</td>';
      tbody.appendChild(tr);
    });
    tbl.style.display='table'; empty.style.display='none';
  } else { meta.textContent=''; tbody.innerHTML=''; tbl.style.display='none'; empty.textContent='Error: '+JSON.stringify(r.data); empty.style.display='block'; }
}
async function doSearch() {
  try {
    const q=JSON.parse(document.getElementById('search-query').value.trim());
    const r=await apiCall('/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q,k:parseInt(document.getElementById('search-k').value),distance:document.getElementById('search-dist').value})});
    renderSearchResults(r,'search-tbody','search-meta','search-results','search-empty');
  } catch(e){ document.getElementById('search-meta').textContent=''; document.getElementById('search-empty').textContent='Invalid JSON: '+e.message; document.getElementById('search-empty').style.display='block'; document.getElementById('search-results').style.display='none'; }
}
async function doRangeSearch() {
  try {
    const q=JSON.parse(document.getElementById('range-query').value.trim());
    const r=await apiCall('/search/range',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q,radius:parseFloat(document.getElementById('range-radius').value),max_results:parseInt(document.getElementById('range-max').value),distance:document.getElementById('range-dist').value})});
    renderSearchResults(r,'range-tbody','range-meta','range-results','range-empty');
  } catch(e){ document.getElementById('range-meta').textContent=''; document.getElementById('range-empty').textContent='Invalid JSON: '+e.message; document.getElementById('range-empty').style.display='block'; document.getElementById('range-results').style.display='none'; }
}

/* Console */
async function consoleSend() {
  const method=document.getElementById('con-method').value, url=document.getElementById('con-url').value;
  const bodyStr=document.getElementById('con-body').value.trim();
  const opts={method}; if (method!=='GET'&&bodyStr){opts.headers={'Content-Type':'application/json'};opts.body=bodyStr;}
  const t0=performance.now(); const r=await apiCall(url,opts); const ms=(performance.now()-t0).toFixed(1);
  document.getElementById('con-meta').innerHTML='<span class="'+(r.status>=200&&r.status<400?'status-ok':'status-err')+'">'+r.status+'</span><span>'+ms+'ms</span>';
  document.getElementById('con-result').innerHTML=jsonHighlight(r.data);
}
function quickReq(method,url){
  document.getElementById('con-method').value=method;document.getElementById('con-url').value=url;document.getElementById('con-body').value='';
  document.querySelectorAll('.sidebar-nav a').forEach(a=>{a.classList.toggle('active',a.dataset.view==='console')});
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById('view-console').classList.add('active');document.getElementById('viewTitle').textContent='Console';consoleSend();
}
document.getElementById('con-url').addEventListener('keydown',e=>{if(e.key==='Enter')consoleSend()});
</script>
</body>
</html>
